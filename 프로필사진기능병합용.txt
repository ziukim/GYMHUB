// member-mapper.xml 
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.gymhub.model.mapper.MemberMapper">
    <resultMap id="memberResultMap" type="Member">
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="MEMBER_TYPE" property="memberType"/>
        <result column="MEMBER_ID" property="memberId"/>
        <result column="MEMBER_PWD" property="memberPwd"/>
        <result column="MEMBER_NAME" property="memberName"/>
        <result column="MEMBER_ADDRESS" property="memberAddress"/>
        <result column="MEMBER_PHONE" property="memberPhone"/>
        <result column="MEMBER_BIRTH" property="memberBirth"/>
        <result column="STATUS" property="status"/>
        <result column="MEMBER_CREATEAT" property="memberCreateat"/>
        <result column="MEMBER_UPDATEAT" property="memberUpdateat"/>
        <result column="MEMBER_EMAIL" property="memberEmail"/>
        <result column="MEMBER_PHOTO_PATH" property="memberPhotoPath"/>
        <result column="GYM_NO" property="gymNo"/>
        <result column="TRAINER_LICENSE" property="trainerLicense"/>
        <result column="TRAINER_CAREER" property="trainerCareer"/>
        <result column="TRAINER_AWARD" property="trainerAward"/>
    </resultMap>

    <select id="getMemberById" parameterType="string" resultMap="memberResultMap">
        SELECT MEMBER_NO,
        MEMBER_TYPE,
        MEMBER_ID,
        MEMBER_PWD,
        MEMBER_NAME,
        MEMBER_ADDRESS,
        MEMBER_PHONE,
        MEMBER_BIRTH,
        STATUS,
        MEMBER_CREATEAT,
        MEMBER_UPDATEAT,
        MEMBER_EMAIL,
        MEMBER_PHOTO_PATH,
        GYM_NO,
        TRAINER_LICENSE,
        TRAINER_CAREER,
        TRAINER_AWARD
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND STATUS = 'Y'
    </select>

    <select id="getMemberCountById" resultType="_int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
    </select>

    <!-- 로그인용 회원 조회 (아이디와 상태만 확인) -->
    <select id="getMemberForLogin" parameterType="string" resultMap="memberResultMap">
        SELECT MEMBER_NO,
        MEMBER_TYPE,
        MEMBER_ID,
        MEMBER_PWD,
        MEMBER_NAME,
        MEMBER_ADDRESS,
        MEMBER_PHONE,
        MEMBER_BIRTH,
        STATUS,
        MEMBER_CREATEAT,
        MEMBER_UPDATEAT,
        MEMBER_EMAIL,
        MEMBER_PHOTO_PATH,
        GYM_NO,
        TRAINER_LICENSE,
        TRAINER_CAREER,
        TRAINER_AWARD
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND STATUS = 'Y'
    </select>

    <insert id="addMember" parameterType="Member">
        <selectKey keyProperty="memberNo" resultType="_int" order="BEFORE">
            SELECT SEQ_MNO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO MEMBER
        (
        MEMBER_NO,
        MEMBER_TYPE,
        MEMBER_ID,
        MEMBER_PWD,
        MEMBER_NAME,
        MEMBER_ADDRESS,
        MEMBER_PHONE,
        MEMBER_BIRTH,
        MEMBER_EMAIL,
        GYM_NO,
        TRAINER_LICENSE,
        TRAINER_CAREER,
        TRAINER_AWARD
        )
        VALUES(
        #{memberNo},
        #{memberType},
        #{memberId},
        #{memberPwd},
        #{memberName},
        #{memberAddress},
        #{memberPhone},
        #{memberBirth},
        #{memberEmail},
        #{gymNo},
        #{trainerLicense},
        #{trainerCareer},
        #{trainerAward}
        )
    </insert>

    <update id="updateMemberInfo" parameterType="Member">
        UPDATE MEMBER
        <set>
            MEMBER_NAME = #{memberName},
            MEMBER_PHONE = #{memberPhone},
            MEMBER_EMAIL = #{memberEmail},
            MEMBER_ADDRESS = #{memberAddress},
            MEMBER_UPDATEAT = SYSDATE,
            <if test="memberBirth != null">
                MEMBER_BIRTH = #{memberBirth},
            </if>
            <!-- 트레이너 정보는 null이 아닐 때만 업데이트 -->
            <if test="trainerCareer != null">
                TRAINER_CAREER = #{trainerCareer},
            </if>
            <if test="trainerLicense != null">
                TRAINER_LICENSE = #{trainerLicense},
            </if>
            <if test="trainerAward != null">
                TRAINER_AWARD = #{trainerAward},
            </if>
        </set>
        WHERE MEMBER_NO = #{memberNo}
    </update>

    <!-- 비밀번호 변경 -->
    <update id="updatePassword">
        UPDATE MEMBER
        SET MEMBER_PWD = #{memberPwd},
        MEMBER_UPDATEAT = SYSDATE
        WHERE MEMBER_NO = #{memberNo}
    </update>

    <!-- 헬스장 등록용 회원 조회 (gym_no가 null인 회원만 조회) -->
    <select id="getMemberByIdForGymRegistration" parameterType="string" resultMap="memberResultMap">
        SELECT MEMBER_NO,
        MEMBER_TYPE,
        MEMBER_ID,
        MEMBER_PWD,
        MEMBER_NAME,
        MEMBER_ADDRESS,
        MEMBER_PHONE,
        MEMBER_BIRTH,
        STATUS,
        MEMBER_CREATEAT,
        MEMBER_UPDATEAT,
        MEMBER_EMAIL,
        MEMBER_PHOTO_PATH,
        GYM_NO,
        TRAINER_LICENSE,
        TRAINER_CAREER,
        TRAINER_AWARD
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND STATUS = 'Y'
        AND GYM_NO IS NULL
    </select>
    <!-- 이미지 업로드 -->
    <update id="updateProfileImage">
        UPDATE MEMBER
        SET MEMBER_PHOTO_PATH = #{photoPath},
        MEMBER_UPDATEAT = SYSDATE
        WHERE MEMBER_NO = #{memberNo}
    </update>
</mapper> 

// MemberController.java
package com.kh.gymhub.controller;

import com.kh.gymhub.model.vo.Gym;
import com.kh.gymhub.model.vo.InbodyRecord;
import com.kh.gymhub.model.vo.Member;
import com.kh.gymhub.service.InbodyService;
import com.kh.gymhub.service.MemberService;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.sql.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Controller
public class MemberController {

    private final MemberService memberService;
    private final BCryptPasswordEncoder bCryptPasswordEncoder;
    private final InbodyService inbodyService;

    @Autowired
    public MemberController(MemberService memberService, BCryptPasswordEncoder bCryptPasswordEncoder, InbodyService inbodyService) {
        this.memberService = memberService;
        this.inbodyService = inbodyService;
        this.bCryptPasswordEncoder = bCryptPasswordEncoder;
    }

    @GetMapping("/dashboard.me")
    public String memberDashboardPage(HttpSession session) {
        // 로그인 체크 (선택사항 - 필요시 추가)
        return "member/memberDashboard";
    }

    @GetMapping("/videoList.me")
    public String memberVideoList() { return "member/memberVideoList"; }

    @GetMapping("/info.me")
    public String memberInfo(HttpSession session, Model model) {
        // 세션에서 로그인 정보 가져오기
        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            // 로그인하지 않은 경우 메인 페이지로 리다이렉트
            session.setAttribute("errorMsg", "로그인이 필요합니다.");
            return "redirect:/";
        }

        // 인바디 기록 목록 조회
        List<InbodyRecord> inbodyList = inbodyService.getInbodyList(loginMember.getMemberNo());

        // Model에 추가
        model.addAttribute("loginMember", loginMember);
        model.addAttribute("inbodyList", inbodyList);

        return "member/memberInfo";
    }

    @GetMapping("/notice.me")
    public String memberNotice() { return "notice/noticeList"; }

    @GetMapping("/schedule.me")
    public String memberPtSchedule() { return "member/ptSchedule"; }

    @GetMapping("/ptBooking.me")
    public String memberptBookingForm() { return "member/ptBookingForm"; }

    @GetMapping("/booking.me")
    public String Booking() { return "booking/booking"; }

    // ====================================== 회원가입 ======================================================
    @GetMapping("/signup/checkId")
    @ResponseBody
    public String checkDuplicateId(@RequestParam String checkId) {
        int count = memberService.getMemberCountById(checkId);
        return count > 0 ? "NNNNN" : "NNNNY";
    }

    @PostMapping("/signup/member.do")
    public String signupMember(@RequestParam String id,
                               @RequestParam String password,
                               @RequestParam String name,
                               @RequestParam String phone,
                               @RequestParam(required = false) String email,
                               @RequestParam(required = false) String address,
                               @RequestParam String birthDate,
                               HttpSession session,
                               Model model) {

        try {
            Member member = new Member();
            member.setMemberType(1);
            member.setMemberId(id);
            member.setMemberPwd(bCryptPasswordEncoder.encode(password));
            member.setMemberName(name);
            member.setMemberPhone(phone);
            member.setMemberAddress(address);
            member.setMemberEmail(email);

            // 생년월일 변환 (YYYYMMDD -> Date)
            if (birthDate != null && birthDate.length() == 8) {
                String formattedDate = birthDate.substring(0, 4) + "-"
                        + birthDate.substring(4, 6) + "-"
                        + birthDate.substring(6, 8);
                member.setMemberBirth(Date.valueOf(formattedDate));
            } else {
                model.addAttribute("errorMsg", "생년월일 형식이 올바르지 않습니다.");
                return "common/error";
            }

            int result = memberService.addMember(member);

            if(result > 0) {
                session.setAttribute("alertMsg", "회원가입에 성공하였습니다.");
                return "redirect:/";
            } else {
                model.addAttribute("errorMsg", "회원가입에 실패하였습니다.");
                return "common/error";
            }
        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("errorMsg", "회원가입 중 오류가 발생했습니다: " + e.getMessage());
            return "common/error";
        }
    }

    @PostMapping("/signup/trainer.do")
    public String signupTrainer(@RequestParam String id,
                                @RequestParam String password,
                                @RequestParam String name,
                                @RequestParam String phone,
                                @RequestParam(required = false) String address,
                                @RequestParam String birthDate,
                                @RequestParam(required = false) String email,
                                @RequestParam(required = false) String career,
                                @RequestParam(required = false) String certification,
                                @RequestParam(required = false) String detailCareer,
                                HttpSession session,
                                Model model) {

        try {
            Member member = new Member();
            member.setMemberType(2);
            member.setMemberId(id);
            member.setMemberPwd(bCryptPasswordEncoder.encode(password));
            member.setMemberName(name);
            member.setMemberPhone(phone);
            member.setMemberAddress(address);
            member.setMemberEmail(email);
            member.setTrainerLicense(certification);
            member.setTrainerCareer(career);
            member.setTrainerAward(detailCareer);

            // 생년월일 변환 (YYYYMMDD -> Date)
            if (birthDate != null && birthDate.length() == 8) {
                String formattedDate = birthDate.substring(0, 4) + "-"
                        + birthDate.substring(4, 6) + "-"
                        + birthDate.substring(6, 8);
                member.setMemberBirth(Date.valueOf(formattedDate));
            } else {
                model.addAttribute("errorMsg", "생년월일 형식이 올바르지 않습니다.");
                return "common/error";
            }

            int result = memberService.addMember(member);

            if(result > 0) {
                session.setAttribute("alertMsg", "트레이너 회원가입에 성공하였습니다.");
                return "redirect:/";
            } else {
                model.addAttribute("errorMsg", "트레이너 회원가입에 실패하였습니다.");
                return "common/error";
            }
        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("errorMsg", "트레이너 회원가입 중 오류가 발생했습니다: " + e.getMessage());
            return "common/error";
        }
    }

    @PostMapping("/signup/gym.do")
    public String signupGym(@RequestParam String id,
                            @RequestParam String password,
                            @RequestParam String phone,
                            @RequestParam(required = false) String address,
                            @RequestParam(required = false) String representative,
                            @RequestParam(required = false) String gymName,
                            @RequestParam(required = false) String email,
                            HttpSession session,
                            Model model) {

        try {
            // Member 객체 생성
            Member member = new Member();
            member.setMemberType(3); // 헬스장 운영자
            member.setMemberId(id);
            member.setMemberPwd(bCryptPasswordEncoder.encode(password));
            member.setMemberName(representative != null ? representative : gymName);
            member.setMemberPhone(phone);
            member.setMemberAddress(address);
            member.setMemberEmail(email);
            member.setMemberBirth(Date.valueOf("1900-01-01")); // 임시값

            // Gym 객체 생성
            Gym gym = new Gym();
            gym.setGymName(gymName != null ? gymName : "미등록 헬스장");
            gym.setGymOwner(representative != null ? representative : "미등록");
            gym.setGymPhone(phone);
            gym.setGymAddress(address != null ? address : "미등록");
            gym.setAttCacheNo(1); // 기본값

            // memberType=3일 때만 addGymOwner 사용 (GYM 테이블 INSERT)
            int result = memberService.addGymOwner(member, gym);

            if(result > 0) {
                session.setAttribute("alertMsg", "헬스장 운영자 회원가입에 성공하였습니다.");
                return "redirect:/";
            } else {
                model.addAttribute("errorMsg", "헬스장 운영자 회원가입에 실패하였습니다.");
                return "common/error";
            }
        } catch (IllegalArgumentException e) {
            // memberType 검증 실패 시
            model.addAttribute("errorMsg", e.getMessage());
            return "common/error";
        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("errorMsg", "헬스장 운영자 회원가입 중 오류가 발생했습니다: " + e.getMessage());
            return "common/error";
        }
    }
    // 회원정보 수정
    @PostMapping("/updateMemberInfo.me")
    public String updateMemberInfo(@RequestParam String memberName,
                                   @RequestParam String birthDate,
                                   @RequestParam String phone,
                                   @RequestParam String email,
                                   @RequestParam String address,
                                   @RequestParam(required = false) String trainerCareer,
                                   @RequestParam(required = false) String trainerLicense,
                                   @RequestParam(required = false) String trainerAward,
                                   HttpSession session,
                                   Model model) {

        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            model.addAttribute("errorMsg", "로그인이 필요합니다.");
            return "common/error";
        }

        // Member 객체에 수정할 정보 설정
        Member updateMember = new Member();
        updateMember.setMemberNo(loginMember.getMemberNo());
        updateMember.setMemberName(memberName);
        updateMember.setMemberPhone(phone);
        updateMember.setMemberEmail(email);
        updateMember.setMemberAddress(address);

        // 트레이너 정보 설정 (memberType이 2인 경우만 해당)
        if (loginMember.getMemberType() == 2) {
            updateMember.setTrainerCareer(trainerCareer);
            updateMember.setTrainerLicense(trainerLicense);
            updateMember.setTrainerAward(trainerAward);
        }

        // 생년월일 변환 (YYYY. MM. DD. 형식 처리)
        if (birthDate != null && !birthDate.isEmpty()) {
            String cleanDate = birthDate.replaceAll("[^0-9]", "");
            if (cleanDate.length() == 8) {
                String formattedDate = cleanDate.substring(0, 4) + "-"
                        + cleanDate.substring(4, 6) + "-"
                        + cleanDate.substring(6, 8);
                updateMember.setMemberBirth(Date.valueOf(formattedDate));
            }
        }

        int result = memberService.updateMemberInfo(updateMember);

        if (result > 0) {
            // 세션 정보 업데이트
            Member updatedMember = memberService.getMemberById(loginMember.getMemberId());
            session.setAttribute("loginMember", updatedMember);
            session.setAttribute("alertMsg", "회원정보가 수정되었습니다.");

            // 회원 타입별 리다이렉트 처리
            if (loginMember.getMemberType() == 2) {
                // 트레이너는 대시보드로
                return "redirect:/dashboard.tr";
            } else if (loginMember.getMemberType() == 3) {
                // 헬스장 운영자는 대시보드로
                return "redirect:/dashboard.gym";
            } else {
                // 일반 회원 및 기타 회원은 마이페이지로
                return "redirect:/info.me";
            }
        } else {
            model.addAttribute("errorMsg", "회원정보 수정에 실패했습니다.");
            return "common/error";
        }
    }

    // 비밀번호 변경
    @PostMapping("/updatePassword.me")
    public String updatePassword(@RequestParam String currentPassword,
                                 @RequestParam String newPassword,
                                 HttpSession session,
                                 Model model) {

        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            model.addAttribute("errorMsg", "로그인이 필요합니다.");
            return "common/error";
        }

        // 현재 비밀번호 확인
        if (!bCryptPasswordEncoder.matches(currentPassword, loginMember.getMemberPwd())) {
            session.setAttribute("errorMsg", "현재 비밀번호가 일치하지 않습니다.");
            return "redirect:/info.me";
        }

        // 새 비밀번호 암호화
        String encodedNewPassword = bCryptPasswordEncoder.encode(newPassword);

        int result = memberService.updatePassword(loginMember.getMemberNo(), encodedNewPassword);

        if (result > 0) {
            session.setAttribute("alertMsg", "비밀번호가 변경되었습니다.");
            return "redirect:/info.me";
        } else {
            model.addAttribute("errorMsg", "비밀번호 변경에 실패했습니다.");
            return "common/error";
        }
    }

    // ====================================== 인바디 기록 ======================================================

    // 인바디 기록 등록
    @PostMapping("/insertInbody.me")
    public String insertInbody(@RequestParam double weight,
                               @RequestParam double muscle,
                               @RequestParam double bodyFat,
                               @RequestParam double bmi,
                               HttpSession session,
                               Model model) {

        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            model.addAttribute("errorMsg", "로그인이 필요합니다.");
            return "common/error";
        }

        InbodyRecord inbody = new InbodyRecord();
        inbody.setMemberNo(loginMember.getMemberNo());
        inbody.setWeight(weight);
        inbody.setSmm(muscle);
        inbody.setPbf(bodyFat);
        inbody.setBmi(bmi);

        int result = inbodyService.insertInbody(inbody);

        if (result > 0) {
            session.setAttribute("alertMsg", "인바디 기록이 등록되었습니다.");
            return "redirect:/info.me";
        } else {
            model.addAttribute("errorMsg", "인바디 기록 등록에 실패했습니다.");
            return "common/error";
        }
    }

    // 인바디 기록 목록 조회
    @GetMapping("/inbodyList.me")
    public String getInbodyList(HttpSession session, Model model) {
        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            model.addAttribute("errorMsg", "로그인이 필요합니다.");
            return "common/error";
        }

        List<InbodyRecord> inbodyList = inbodyService.getInbodyList(loginMember.getMemberNo());
        model.addAttribute("inbodyList", inbodyList);

        return "member/inbodyList";
    }

    // 최근 인바디 기록 조회 (Ajax용)
    @GetMapping("/latestInbody.me")
    @ResponseBody
    public InbodyRecord getLatestInbody(HttpSession session) {
        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            return null;
        }

        return inbodyService.getLatestInbody(loginMember.getMemberNo());
    }



    // ====================================== 로그인 ======================================================
    @PostMapping("/login.me")
    public String login(@RequestParam String id,
                       @RequestParam String password,
                       HttpSession session) {
        
        Member loginMember = memberService.login(id, password);
        
        if (loginMember != null) {
            // 세션에 로그인 정보 저장
            session.setAttribute("loginMember", loginMember);
            
            // 멤버 타입 3(헬스장 운영자)이면 관리자 선택 페이지로 이동
            if (loginMember.getMemberType() == 3) {
                session.setAttribute("alertMsg", loginMember.getMemberName() + "님 환영합니다!");
                return "redirect:/adminSelect.gym";
            }
            
            session.setAttribute("alertMsg", loginMember.getMemberName() + "님 환영합니다!");
            return "redirect:/";
        } else {
            session.setAttribute("errorMsg", "아이디 또는 비밀번호가 올바르지 않습니다.");
            return "redirect:/";
        }
    }

    // ============================================== 로그 아웃 ========================================================
    @GetMapping("/logout.me")
    public String logout(HttpSession session) {
        // 세션 완전 무효화
        session.invalidate();
        return "redirect:/?logout=success";
    }

    // ============================================== 이미지 업로드 =======================================================
    @PostMapping("/uploadProfileImage.me")
    @ResponseBody
    public Map<String, Object> uploadProfileImage(@RequestParam("profileImage") MultipartFile file,
                                                  HttpSession session,
                                                  HttpServletRequest request) {
        Map<String, Object> result = new HashMap<>();

        Member loginMember = (Member) session.getAttribute("loginMember");

        if (loginMember == null) {
            result.put("success", false);
            result.put("message", "로그인이 필요합니다.");
            return result;
        }

        if (file.isEmpty()) {
            result.put("success", false);
            result.put("message", "파일이 선택되지 않았습니다.");
            return result;
        }

        try {
            // 파일 저장 경로 설정
            String uploadPath = session.getServletContext().getRealPath("/resources/uploadfiles/Member");
            File uploadDir = new File(uploadPath);

            // 디렉토리가 없으면 생성
            if (!uploadDir.exists()) {
                uploadDir.mkdirs();
            }

            // 원본 파일명
            String originalFilename = file.getOriginalFilename();

            // 확장자 추출
            String extension = "";
            if (originalFilename != null && originalFilename.contains(".")) {
                extension = originalFilename.substring(originalFilename.lastIndexOf("."));
            }

            // 고유한 파일명 생성 (회원번호_타임스탬프.확장자)
            String savedFilename = loginMember.getMemberNo() + "_" + System.currentTimeMillis() + extension;

            // 파일 저장
            File destFile = new File(uploadDir, savedFilename);
            file.transferTo(destFile);

            // DB에 저장할 경로 (상대 경로)
            String dbPath = "/resources/uploadfiles/Member/" + savedFilename;

            // DB 업데이트
            int updateResult = memberService.updateProfileImage(loginMember.getMemberNo(), dbPath);

            if (updateResult > 0) {
                // 세션 정보 업데이트
                Member updatedMember = memberService.getMemberById(loginMember.getMemberId());
                session.setAttribute("loginMember", updatedMember);

                result.put("success", true);
                result.put("message", "프로필 이미지가 업데이트되었습니다.");
                result.put("imagePath", request.getContextPath() + dbPath);
            } else {
                result.put("success", false);
                result.put("message", "DB 업데이트에 실패했습니다.");
            }

        } catch (Exception e) {
            e.printStackTrace();
            result.put("success", false);
            result.put("message", "파일 업로드 중 오류가 발생했습니다: " + e.getMessage());
        }

        return result;
    }

}

//memberMapper.java
package com.kh.gymhub.model.mapper;

import com.kh.gymhub.model.vo.Member;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface MemberMapper {
    Member getMemberById(@Param("memberId") String memberId);
    int getMemberCountById(@Param("memberId") String memberId);
    int addMember(Member member);
    int updateMemberInfo(Member member);
    int updatePassword(@Param("memberNo") int memberNo, @Param("memberPwd") String memberPwd);
    int updateProfileImage(@Param("memberNo") int memberNo, @Param("photoPath") String photoPath);
    Member getMemberForLogin(@Param("memberId") String memberId);
    Member getMemberByIdForGymRegistration(@Param("memberId") String memberId);
}

//MembeService.java
package com.kh.gymhub.service;

import com.kh.gymhub.model.vo.Gym;
import com.kh.gymhub.model.vo.Member;

public interface MemberService {
    Member getMemberById(String memberId);
    int getMemberCountById(String memberId);
    int addMember(Member member);
    int addGymOwner(Member member, Gym gym);
    int updateMemberInfo(Member member);
    int updatePassword(int memberNo, String newPassword);
    int updateProfileImage(int memberNo, String photoPath);
    Member login(String memberId, String memberPwd);
    Member getMemberByIdForGymRegistration(String memberId);

}

// MemberServiceImpl
package com.kh.gymhub.service;

import com.kh.gymhub.model.mapper.MemberMapper;
import com.kh.gymhub.model.vo.Gym;
import com.kh.gymhub.model.vo.Member;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class MemberServiceImpl implements MemberService {

    private final MemberMapper memberMapper;
    private final BCryptPasswordEncoder bCryptPasswordEncoder;
    private final GymService gymService;

    @Autowired
    public MemberServiceImpl(MemberMapper memberMapper,
                             BCryptPasswordEncoder bCryptPasswordEncoder,
                             GymService gymService) {
        this.memberMapper = memberMapper;
        this.bCryptPasswordEncoder = bCryptPasswordEncoder;
        this.gymService = gymService;
    }

    @Override
    public Member getMemberById(String memberId) {
        return memberMapper.getMemberById(memberId);
    }

    @Override
    public int getMemberCountById(String memberId) {
        return memberMapper.getMemberCountById(memberId);
    }

    @Override
    @Transactional
    public int addMember(Member member) {
        return memberMapper.addMember(member);
    }

    @Override
    @Transactional
    public int addGymOwner(Member member, Gym gym) {
        // 1. GYM 테이블에 먼저 INSERT (GYM_NO 생성)
        int gymResult = gymService.addGym(gym);

        if (gymResult > 0) {
            // 2. 생성된 GYM_NO를 Member에 설정
            member.setGymNo(gym.getGymNo());

            // 3. MEMBER 테이블에 INSERT
            int memberResult = memberMapper.addMember(member);

            return memberResult;
        }

        return 0;
    }

    @Override
    public Member login(String memberId, String memberPwd) {
        // 로그인 전용 쿼리로 회원 정보 조회
        Member member = memberMapper.getMemberForLogin(memberId);

        // 회원이 존재하고 비밀번호가 일치하는지 확인
        if (member != null && bCryptPasswordEncoder.matches(memberPwd, member.getMemberPwd())) {
            return member;
        }

        return null;
    }

    @Override
    @Transactional
    public int updateMemberInfo(Member member) {
        return memberMapper.updateMemberInfo(member);
    }

    @Override
    @Transactional
    public int updatePassword(int memberNo, String newPassword) {
        return memberMapper.updatePassword(memberNo, newPassword);
    }

    @Override
    public Member getMemberByIdForGymRegistration(String memberId) {
        return memberMapper.getMemberByIdForGymRegistration(memberId);
    }

    @Override
    @Transactional
    public int updateProfileImage(int memberNo, String photoPath) {
        return memberMapper.updateProfileImage(memberNo, photoPath);
    }
}