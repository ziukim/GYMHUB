<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.gymhub.model.mapper.GymMapper">
    <resultMap id="gymResultMap" type="Gym">
        <id column="GYM_NO" property="gymNo"/>
        <result column="GYM_NAME" property="gymName"/>
        <result column="GYM_OWNER" property="gymOwner"/>
        <result column="GYM_PHONE" property="gymPhone"/>
        <result column="GYM_ADDRESS" property="gymAddress"/>
        <result column="STATUS" property="status"/>
        <result column="GYM_CREATEAT" property="gymCreateat"/>
        <result column="GYM_UPDATEAT" property="gymUpdateat"/>
        <result column="GYM_PHOTO_PATH" property="gymPhotoPath"/>
        <result column="ATT_CACHE_NO" property="attCacheNo"/>
    </resultMap>

    <insert id="insertGym" parameterType="Gym">
        <selectKey keyProperty="gymNo" resultType="_int" order="BEFORE">
            SELECT SEQ_GYM_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO GYM (
            GYM_NO,
            GYM_NAME,
            GYM_OWNER,
            GYM_PHONE,
            GYM_ADDRESS
        ) VALUES (
            #{gymNo},
            #{gymName},
            #{gymOwner},
            #{gymPhone},
            #{gymAddress}
        )
    </insert>

    <select id="selectGymByNo" parameterType="_int" resultMap="gymResultMap">
        SELECT
            GYM_NO,
            GYM_NAME,
            GYM_OWNER,
            GYM_PHONE,
            GYM_ADDRESS,
            STATUS,
            GYM_CREATEAT,
            GYM_UPDATEAT,
            GYM_PHOTO_PATH
        FROM GYM
        WHERE GYM_NO = #{gymNo}
        AND STATUS = 'Y'
    </select>

    <select id="selectAllGyms" resultMap="gymResultMap">
        SELECT
            GYM_NO,
            GYM_NAME,
            GYM_OWNER,
            GYM_PHONE,
            GYM_ADDRESS,
            STATUS,
            GYM_CREATEAT,
            GYM_UPDATEAT,
            GYM_PHOTO_PATH
        FROM GYM
        WHERE STATUS = 'Y'
        ORDER BY GYM_NO DESC
    </select>

    <!-- 1개월 회원권 가격 기준으로 정렬된 헬스장 목록 조회 -->
    <select id="selectAllGymsWithSort" parameterType="string" resultMap="gymResultMap">
        SELECT
        G.GYM_NO,
        G.GYM_NAME,
        G.GYM_OWNER,
        G.GYM_PHONE,
        G.GYM_ADDRESS,
        G.STATUS,
        G.GYM_CREATEAT,
        G.GYM_UPDATEAT,
        G.GYM_PHOTO_PATH,
        FROM GYM G
        LEFT JOIN (
        SELECT
        GYM_NO,
        PRODUCT_PRICE
        FROM PRODUCT
        WHERE PRODUCT_TYPE = '회원권'
        AND DURATION_MONTHS = 30
        ) P ON G.GYM_NO = P.GYM_NO
        WHERE G.STATUS = 'Y'
        ORDER BY
        CASE
        WHEN P.PRODUCT_PRICE IS NULL THEN 1
        ELSE 0
        END,
        <choose>
            <when test="sortType == 'price-low'">
                P.PRODUCT_PRICE ASC NULLS LAST
            </when>
            <when test="sortType == 'price-high'">
                P.PRODUCT_PRICE DESC NULLS LAST
            </when>
            <otherwise>
                G.GYM_NO DESC
            </otherwise>
        </choose>
    </select>

    <update id="updateProfileImage">
        UPDATE GYM
        SET GYM_PHOTO_PATH = #{photoPath},
        GYM_UPDATEAT = SYSDATE
        WHERE GYM_NO = #{gymNo}
    </update>

    <update id="updateGym" parameterType="Gym">
        UPDATE GYM
        <set>
            <if test="gymName != null and gymName != ''">GYM_NAME = #{gymName},</if>
            <if test="gymPhone != null and gymPhone != ''">GYM_PHONE = #{gymPhone},</if>
            <if test="gymAddress != null and gymAddress != ''">GYM_ADDRESS = #{gymAddress},</if>
            GYM_UPDATEAT = SYSDATE
        </set>
        WHERE GYM_NO = #{gymNo}
    </update>
</mapper>