<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.gymhub.model.mapper.GymMapper">
    <resultMap id="gymResultMap" type="Gym">
        <id column="GYM_NO" property="gymNo"/>
        <result column="GYM_NAME" property="gymName"/>
        <result column="GYM_OWNER" property="gymOwner"/>
        <result column="GYM_PHONE" property="gymPhone"/>
        <result column="GYM_ADDRESS" property="gymAddress"/>
        <result column="STATUS" property="status"/>
        <result column="GYM_CREATEAT" property="gymCreateat"/>
        <result column="GYM_UPDATEAT" property="gymUpdateat"/>
        <result column="GYM_PHOTO_PATH" property="gymPhotoPath"/>
        <result column="ATT_CACHE_NO" property="attCacheNo"/>

        <!-- GYM_DETAIL 테이블 컬럼 -->
        <result column="INTRO" property="intro"/>
        <result column="FACILITIES_INFO" property="facilitiesInfo"/>
        <result column="DETAIL_ADDRESS" property="detailAddress"/>
        <result column="WEEK_BUSINESS_HOUR" property="weekBusinessHour"/>
        <result column="WEEKEND_BUSINESS_HOUR" property="weekendBusinessHour"/>

        <!-- PRODUCT 테이블과 JOIN (collection) -->
        <collection property="products" ofType="Product">
            <id column="PRODUCT_NO" property="productNo"/>
            <result column="PRODUCT_GYM_NO" property="gymNo"/>
            <result column="DURATION_MONTHS" property="durationMonths"/>
            <result column="PRODUCT_TYPE" property="productType"/>
            <result column="PRODUCT_START_DATE" property="productStartDate"/>
            <result column="PRODUCT_PRICE" property="productPrice"/>
            <result column="PRODUCT_STATUS" property="productStatus"/>
        </collection>
    </resultMap>

    <insert id="insertGym" parameterType="Gym">
        <selectKey keyProperty="gymNo" resultType="_int" order="BEFORE">
            SELECT SEQ_GYM_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO GYM (
        GYM_NO,
        GYM_NAME,
        GYM_OWNER,
        GYM_PHONE,
        GYM_ADDRESS,
        ATT_CACHE_NO
        ) VALUES (
        #{gymNo},
        #{gymName},
        #{gymOwner},
        #{gymPhone},
        #{gymAddress},
        #{attCacheNo}
        )
    </insert>

    <select id="selectGymWithDetailByNo" parameterType="_int" resultMap="gymResultMap">
        SELECT
        G.GYM_NO,
        G.GYM_NAME,
        G.GYM_OWNER,
        G.GYM_PHONE,
        G.GYM_ADDRESS,
        G.STATUS,
        G.GYM_CREATEAT,
        G.GYM_UPDATEAT,
        G.GYM_PHOTO_PATH,
        G.ATT_CACHE_NO,
        GD.INTRO,
        GD.FACILITIES_INFO,
        GD.DETAIL_ADDRESS,
        GD.WEEK_BUSINESS_HOUR,
        GD.WEEKEND_BUSINESS_HOUR,
        P.PRODUCT_NO,
        P.GYM_NO AS PRODUCT_GYM_NO,
        P.DURATION_MONTHS,
        P.PRODUCT_TYPE,
        P.PRODUCT_START_DATE,
        P.PRODUCT_PRICE,
        P.PRODUCT_STATUS
        FROM GYM G
        LEFT JOIN GYM_DETAIL GD ON G.GYM_NO = GD.GYM_NO
        LEFT JOIN PRODUCT P ON G.GYM_NO = P.GYM_NO AND P.PRODUCT_STATUS = 'Y'
        WHERE G.GYM_NO = #{gymNo}
        AND G.STATUS = 'Y'
        ORDER BY P.PRODUCT_TYPE, P.DURATION_MONTHS
    </select>

    <!-- 모든 헬스장 목록 조회 -->
    <select id="selectAllGyms" resultMap="gymResultMap">
        SELECT
        G.GYM_NO,
        G.GYM_NAME,
        G.GYM_OWNER,
        G.GYM_PHONE,
        G.GYM_ADDRESS,
        G.STATUS,
        G.GYM_CREATEAT,
        G.GYM_UPDATEAT,
        G.GYM_PHOTO_PATH,
        G.ATT_CACHE_NO,
        GD.INTRO,
        GD.FACILITIES_INFO,
        GD.DETAIL_ADDRESS,
        GD.WEEK_BUSINESS_HOUR,
        GD.WEEKEND_BUSINESS_HOUR
        FROM GYM G
        LEFT JOIN GYM_DETAIL GD ON G.GYM_NO = GD.GYM_NO
        WHERE G.STATUS = 'Y'
        ORDER BY G.GYM_NO DESC
    </select>

    <update id="updateProfileImage">
        UPDATE GYM
        SET GYM_PHOTO_PATH = #{photoPath},
        GYM_UPDATEAT = SYSDATE
        WHERE GYM_NO = #{gymNo}
    </update>
</mapper>