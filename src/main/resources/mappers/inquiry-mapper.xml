<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.gymhub.model.mapper.InquiryMapper">

    <resultMap id="inquiryReserveResultMap" type="com.kh.gymhub.model.vo.InquiryReserve">
        <id property="inquiryNo" column="INQUIRY_NO"/>
        <result property="gymNo" column="GYM_NO"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="visitDatetime" column="VISIT_DATETIME"/>
        <result property="request" column="REQUEST"/>
        <result property="inquiryStatus" column="INQUIRY_STATUS"/>
        <result property="inquiryMemo" column="INQUIRY_MEMO"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberPhone" column="MEMBER_PHONE"/>
    </resultMap>

    <!-- 헬스장 번호로 승인된 미래 예약 목록 조회 -->
    <select id="selectApprovedFutureReservationsByGymNo" resultMap="inquiryReserveResultMap">
        SELECT 
            IR.INQUIRY_NO,
            IR.GYM_NO,
            IR.MEMBER_NO,
            IR.VISIT_DATETIME,
            IR.REQUEST,
            IR.INQUIRY_STATUS,
            IR.INQUIRY_MEMO,
            M.MEMBER_NAME
        FROM INQUIRY_RESERVE IR
        INNER JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
        WHERE IR.GYM_NO = #{gymNo}
        AND IR.INQUIRY_STATUS = '승인됨'
        AND IR.VISIT_DATETIME >= SYSDATE
        ORDER BY IR.VISIT_DATETIME ASC
    </select>

    <!-- 헬스장 번호로 '예약' 및 '완료' 상태의 예약 목록 조회 -->
    <select id="selectReservedInquiriesByGymNo" resultMap="inquiryReserveResultMap">
        SELECT 
            IR.INQUIRY_NO,
            IR.GYM_NO,
            IR.MEMBER_NO,
            IR.VISIT_DATETIME,
            IR.REQUEST,
            IR.INQUIRY_STATUS,
            IR.INQUIRY_MEMO,
            M.MEMBER_NAME,
            M.MEMBER_PHONE
        FROM INQUIRY_RESERVE IR
        INNER JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
        WHERE IR.GYM_NO = #{gymNo}
        AND IR.INQUIRY_STATUS IN ('예약', '완료')
        ORDER BY 
            CASE WHEN IR.INQUIRY_STATUS = '예약' THEN 0 ELSE 1 END,
            IR.VISIT_DATETIME ASC
    </select>

    <!-- 예약 상태를 '완료'로 업데이트 -->
    <update id="updateInquiryStatusToCompleted">
        UPDATE INQUIRY_RESERVE
        SET INQUIRY_STATUS = '완료'
        WHERE INQUIRY_NO = #{inquiryNo}
    </update>

</mapper>

