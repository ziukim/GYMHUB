<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.gymhub.model.mapper.LockerMapper">

    <resultMap id="lockerPassResultMap" type="com.kh.gymhub.model.vo.LockerPass">
        <id property="lockerPassNo" column="LOCKER_PASS_NO"/>
        <result property="purchaseNo" column="PURCHASE_NO"/>
        <result property="lockerNo" column="LOCKER_NO"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="lockerPassStart" column="LOCKER_PASS_START"/>
        <result property="lockerEnd" column="LOCKER_END"/>
        <result property="lockerPassStatus" column="LOCKER_PASS_STATUS"/>
        <result property="lockerRealNum" column="LOCKER_REAL_NUM"/>
        <result property="lockerStatus" column="LOCKER_STATUS"/>
        <result property="memberName" column="MEMBER_NAME"/>
    </resultMap>

    <select id="selectLockerPassListByGymNo" resultMap="lockerPassResultMap">
        SELECT
            L.LOCKER_NO,
            L.LOCKER_REAL_NUM,
            L.LOCKER_STATUS,
            LP.LOCKER_PASS_NO,
            LP.PURCHASE_NO,
            LP.MEMBER_NO,
            LP.LOCKER_PASS_START,
            LP.LOCKER_END,
            LP.LOCKER_PASS_STATUS,
            M.MEMBER_NAME
        FROM LOCKER L
        LEFT JOIN LOCKER_PASS LP ON L.LOCKER_NO = LP.LOCKER_NO 
            AND LP.LOCKER_PASS_STATUS = '정상'
        LEFT JOIN MEMBER M ON LP.MEMBER_NO = M.MEMBER_NO
        WHERE L.GYM_NO = #{gymNo}

        ORDER BY L.LOCKER_REAL_NUM ASC
    </select>

    <insert id="insertLocker" parameterType="com.kh.gymhub.model.vo.Locker">
        INSERT INTO LOCKER (
            LOCKER_NO,
            GYM_NO,
            LOCKER_REAL_NUM,
            LOCKER_STATUS
        ) VALUES (
            SEQ_LOCKER_NO.NEXTVAL,
            #{gymNo},
            #{lockerRealNum},
            #{lockerStatus}
        )
    </insert>

    <update id="updateExpiredLockerPassStatus">
        UPDATE LOCKER_PASS
        SET LOCKER_PASS_STATUS = '만료'
        WHERE LOCKER_END &lt; TRUNC(SYSDATE)
        AND LOCKER_PASS_STATUS != '만료'
    </update>

    <update id="updateLockerStatusForExpiredPasses">
        UPDATE LOCKER L
        SET L.LOCKER_STATUS = '빈'
        WHERE L.LOCKER_NO IN (
            SELECT LP.LOCKER_NO
            FROM LOCKER_PASS LP
            WHERE LP.LOCKER_PASS_STATUS = '만료'
        )
        AND L.LOCKER_STATUS != '빈'
    </update>

    <insert id="insertLockerPass" parameterType="com.kh.gymhub.model.vo.LockerPass">
        <selectKey keyProperty="lockerPassNo" resultType="_int" order="BEFORE">
            SELECT SEQ_LOCKER_PASS_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO LOCKER_PASS (
            LOCKER_PASS_NO,
            PURCHASE_NO,
            LOCKER_NO,
            MEMBER_NO,
            LOCKER_PASS_START,
            LOCKER_END,
            LOCKER_PASS_STATUS
        ) VALUES (
            #{lockerPassNo},
            #{purchaseNo},
            #{lockerNo},
            #{memberNo},
            #{lockerPassStart},
            #{lockerEnd},
            #{lockerPassStatus}
        )
    </insert>

    <select id="selectLockerByRealNum" resultType="com.kh.gymhub.model.vo.LockerPass">
        SELECT L.LOCKER_NO as lockerNo,
               L.LOCKER_REAL_NUM as lockerRealNum
        FROM LOCKER L
        WHERE L.LOCKER_REAL_NUM = #{lockerRealNum}
        AND L.GYM_NO = #{gymNo}
    </select>

    <update id="updateLockerStatus">
        UPDATE LOCKER
        SET LOCKER_STATUS = #{lockerStatus}
        WHERE LOCKER_NO = #{lockerNo}
    </update>

    <select id="selectLockerByNo" resultType="com.kh.gymhub.model.vo.Locker">
        SELECT
            LOCKER_NO as lockerNo,
            GYM_NO as gymNo,
            LOCKER_REAL_NUM as lockerRealNum,
            LOCKER_STATUS as lockerStatus
        FROM LOCKER
        WHERE LOCKER_NO = #{lockerNo}
    </select>

    <select id="countActiveLockerPassByLockerNo" resultType="_int">
        SELECT COUNT(*)
        FROM LOCKER_PASS
        WHERE LOCKER_NO = #{lockerNo}
        AND LOCKER_PASS_STATUS = '정상'
        AND LOCKER_END >= TRUNC(SYSDATE)
    </select>

    <!-- 회원번호로 락커 이용권 조회 -->
    <select id="selectLockerPassByMemberNo" resultMap="lockerPassResultMap">
        SELECT 
            LP.LOCKER_PASS_NO,
            LP.PURCHASE_NO,
            LP.LOCKER_NO,
            LP.MEMBER_NO,
            LP.LOCKER_PASS_START,
            LP.LOCKER_END,
            LP.LOCKER_PASS_STATUS,
            L.LOCKER_REAL_NUM,
            L.LOCKER_STATUS
        FROM LOCKER_PASS LP
        INNER JOIN LOCKER L ON LP.LOCKER_NO = L.LOCKER_NO
        WHERE LP.MEMBER_NO = #{memberNo}
          AND L.GYM_NO = #{gymNo}
          AND LP.LOCKER_PASS_STATUS = '정상'
          AND ROWNUM = 1
        ORDER BY LP.LOCKER_END DESC
    </select>

    <!-- 회원번호로 락커 이용권 조회 (만료된 것 포함) -->
    <select id="selectLockerPassByMemberNoIncludingExpired" resultMap="lockerPassResultMap">
        SELECT 
            LP.LOCKER_PASS_NO,
            LP.PURCHASE_NO,
            LP.LOCKER_NO,
            LP.MEMBER_NO,
            LP.LOCKER_PASS_START,
            LP.LOCKER_END,
            LP.LOCKER_PASS_STATUS,
            L.LOCKER_REAL_NUM,
            L.LOCKER_STATUS
        FROM LOCKER_PASS LP
        INNER JOIN LOCKER L ON LP.LOCKER_NO = L.LOCKER_NO
        WHERE LP.MEMBER_NO = #{memberNo}
          AND L.GYM_NO = #{gymNo}
          AND ROWNUM = 1
        ORDER BY LP.LOCKER_END DESC
    </select>

    <!-- 락커 이용권 만료일 연장 -->
    <update id="updateLockerPassEndDate">
        UPDATE LOCKER_PASS
        SET LOCKER_END = #{newEndDate}
        WHERE LOCKER_PASS_NO = #{lockerPassNo}
    </update>

    <!-- 락커 이용권의 락커번호 변경 -->
    <update id="updateLockerPassLockerNo">
        UPDATE LOCKER_PASS
        SET LOCKER_NO = #{newLockerNo}
        WHERE LOCKER_PASS_NO = #{lockerPassNo}
    </update>

    <!-- 락커 이용권 상태를 만료로 변경 -->
    <update id="updateLockerPassStatusToExpired">
        UPDATE LOCKER_PASS
        SET LOCKER_PASS_STATUS = '만료'
        WHERE LOCKER_PASS_NO = #{lockerPassNo}
    </update>

    <!-- 락커 이용권 상태를 정상으로 변경 (만료된 락커 재활성화) -->
    <update id="updateLockerPassStatusToActive">
        UPDATE LOCKER_PASS
        SET LOCKER_PASS_STATUS = '정상'
        WHERE LOCKER_PASS_NO = #{lockerPassNo}
    </update>

    <!-- 회원 탈퇴 시 락커 이용권 만료 처리 -->
    <update id="expireLockerPassesByMemberNo">
        UPDATE LOCKER_PASS
        SET LOCKER_PASS_STATUS = '만료'
        WHERE MEMBER_NO = #{memberNo}
          AND LOCKER_PASS_STATUS = '정상'
    </update>

    <!-- 락커 실제 번호로 락커 조회 -->
    <select id="selectLockerByRealNumAndGymNo" resultType="com.kh.gymhub.model.vo.Locker">
        SELECT
            LOCKER_NO as lockerNo,
            GYM_NO as gymNo,
            LOCKER_REAL_NUM as lockerRealNum,
            LOCKER_STATUS as lockerStatus
        FROM LOCKER
        WHERE LOCKER_REAL_NUM = #{lockerRealNum}
        AND GYM_NO = #{gymNo}
    </select>

</mapper>

