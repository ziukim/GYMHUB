<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.gymhub.model.mapper.InquiryMapper">

    <!-- ✅ 기본 ResultMap -->
    <resultMap id="inquiryReserveResultMap" type="InquiryReserve">
        <id column="INQUIRY_NO" property="inquiryNo"/>
        <result column="GYM_NO" property="gymNo"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="VISIT_DATETIME" property="visitDatetime"/>
        <result column="INQUIRY_STATUS" property="inquiryStatus"/>
        <result column="INQUIRY_MEMO" property="inquiryMemo"/>
    </resultMap>

    <!-- ✅ 회원 정보 포함 ResultMap -->
    <resultMap id="inquiryReserveWithMemberResultMap" type="InquiryReserve">
        <id column="INQUIRY_NO" property="inquiryNo"/>
        <result column="GYM_NO" property="gymNo"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="VISIT_DATETIME" property="visitDatetime"/>
        <result column="INQUIRY_STATUS" property="inquiryStatus"/>
        <result column="INQUIRY_MEMO" property="inquiryMemo"/>
        <result column="MEMBER_NAME" property="memberName"/>
        <result column="MEMBER_PHONE" property="memberPhone"/>
    </resultMap>

    <select id="selectReserveByMemberNo" parameterType="_int" resultMap="inquiryReserveResultMap">
        SELECT
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        FROM INQUIRY_RESERVE
        WHERE MEMBER_NO = #{memberNo}
        AND INQUIRY_STATUS IN ('예약', '대기')
        ORDER BY VISIT_DATETIME DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="selectReserveByMemberAndGym" resultMap="inquiryReserveResultMap">
        SELECT
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        FROM INQUIRY_RESERVE
        WHERE MEMBER_NO = #{param1}
        AND GYM_NO = #{param2}
        AND INQUIRY_STATUS IN ('예약', '대기')
        ORDER BY VISIT_DATETIME DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="selectReservedTimesByGymNo" parameterType="_int" resultMap="inquiryReserveResultMap">
        SELECT
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        FROM INQUIRY_RESERVE
        WHERE GYM_NO = #{gymNo}
        AND INQUIRY_STATUS IN ('예약', '대기')
        AND VISIT_DATETIME >= SYSDATE
        ORDER BY VISIT_DATETIME ASC
    </select>

    <insert id="insertReserve" parameterType="InquiryReserve">
        INSERT INTO INQUIRY_RESERVE (
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        ) VALUES (
        SEQ_INQUIRY_NO.NEXTVAL,
        #{gymNo},
        #{memberNo},
        #{visitDatetime},
        #{inquiryStatus},
        #{inquiryMemo}
        )
    </insert>

    <update id="updateReserve" parameterType="InquiryReserve">
        UPDATE INQUIRY_RESERVE
        SET VISIT_DATETIME = #{visitDatetime},
        INQUIRY_STATUS = #{inquiryStatus},
        INQUIRY_MEMO = #{inquiryMemo}
        WHERE INQUIRY_NO = #{inquiryNo}
    </update>

    <delete id="deleteReserve" parameterType="_int">
        DELETE FROM INQUIRY_RESERVE
        WHERE INQUIRY_NO = #{inquiryNo}
    </delete>

    <!-- ✅ 헬스장 번호로 모든 예약 조회 (회원 정보 포함) -->
    <select id="selectReservationsByGymNo" parameterType="_int" resultMap="inquiryReserveWithMemberResultMap">
        SELECT
        IR.INQUIRY_NO,
        IR.GYM_NO,
        IR.MEMBER_NO,
        IR.VISIT_DATETIME,
        IR.INQUIRY_STATUS,
        IR.INQUIRY_MEMO,
        M.MEMBER_NAME,
        M.MEMBER_PHONE
        FROM INQUIRY_RESERVE IR
        JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
        WHERE IR.GYM_NO = #{gymNo}
        ORDER BY IR.VISIT_DATETIME DESC
    </select>

    <!-- ✅ 헬스장 번호로 예약 조회 (페이징) -->
    <select id="selectReservationsByGymNoPaged" resultMap="inquiryReserveWithMemberResultMap">
        SELECT * FROM (
            SELECT ROWNUM RNUM, A.* FROM (
                SELECT
                    IR.INQUIRY_NO,
                    IR.GYM_NO,
                    IR.MEMBER_NO,
                    IR.VISIT_DATETIME,
                    IR.INQUIRY_STATUS,
                    IR.INQUIRY_MEMO,
                    M.MEMBER_NAME,
                    M.MEMBER_PHONE
                FROM INQUIRY_RESERVE IR
                JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
                WHERE IR.GYM_NO = #{gymNo}
                ORDER BY IR.VISIT_DATETIME DESC
            ) A
        ) WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- ✅ 헬스장 번호로 예약 수 조회 (페이징용) -->
    <select id="selectReservationCountByGymNo" parameterType="_int" resultType="_int">
        SELECT COUNT(*)
        FROM INQUIRY_RESERVE IR
        JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
        WHERE IR.GYM_NO = #{gymNo}
    </select>

    <!-- ✅ 헬스장 번호로 오늘 날짜 예약 조회 (회원 정보 포함) -->
    <select id="selectTodayReservationsByGymNo" parameterType="_int" resultMap="inquiryReserveWithMemberResultMap">
        SELECT
        IR.INQUIRY_NO,
        IR.GYM_NO,
        IR.MEMBER_NO,
        IR.VISIT_DATETIME,
        IR.INQUIRY_STATUS,
        IR.INQUIRY_MEMO,
        M.MEMBER_NAME,
        M.MEMBER_PHONE
        FROM INQUIRY_RESERVE IR
        JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
        WHERE IR.GYM_NO = #{gymNo}
          AND TRUNC(IR.VISIT_DATETIME) = TRUNC(SYSDATE)
        ORDER BY IR.VISIT_DATETIME ASC
    </select>

    <!-- ✅ 예약 상태 업데이트 -->
    <update id="updateInquiryStatus">
        UPDATE INQUIRY_RESERVE
        SET INQUIRY_STATUS = #{status}
        WHERE INQUIRY_NO = #{inquiryNo}
    </update>

    <!-- ✅ 날짜별 예약 상담 조회 (헬스장별) -->
    <select id="selectReservationsByGymNoAndDate" resultMap="inquiryReserveWithMemberResultMap">
        SELECT
        IR.INQUIRY_NO,
        IR.GYM_NO,
        IR.MEMBER_NO,
        IR.VISIT_DATETIME,
        IR.INQUIRY_STATUS,
        IR.INQUIRY_MEMO,
        M.MEMBER_NAME,
        M.MEMBER_PHONE
        FROM INQUIRY_RESERVE IR
        JOIN MEMBER M ON IR.MEMBER_NO = M.MEMBER_NO
        WHERE IR.GYM_NO = #{gymNo}
          AND TRUNC(IR.VISIT_DATETIME) = TO_DATE(#{reserveDate}, 'YYYY-MM-DD')
        ORDER BY IR.VISIT_DATETIME DESC
    </select>

</mapper>