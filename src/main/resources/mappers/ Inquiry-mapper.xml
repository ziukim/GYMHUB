<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.gymhub.model.dao.InquiryMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="inquiryReserveResultMap" type="InquiryReserve">
        <id column="INQUIRY_NO" property="inquiryNo"/>
        <result column="GYM_NO" property="gymNo"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="VISIT_DATETIME" property="visitDatetime"/>
        <result column="INQUIRY_STATUS" property="inquiryStatus"/>
        <result column="INQUIRY_MEMO" property="inquiryMemo"/>
    </resultMap>

    <!-- 회원 번호로 예약 조회 (가장 최근 예약 1건) -->
    <select id="selectReserveByMemberNo" parameterType="_int" resultMap="inquiryReserveResultMap">
        SELECT
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        FROM INQUIRY_RESERVE
        WHERE MEMBER_NO = #{memberNo}
        AND INQUIRY_STATUS IN ('예약', '대기')
        ORDER BY VISIT_DATETIME DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 회원 번호와 헬스장 번호로 예약 조회 -->
    <select id="selectReserveByMemberAndGym" resultMap="inquiryReserveResultMap">
        SELECT
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        FROM INQUIRY_RESERVE
        WHERE MEMBER_NO = #{memberNo}
        AND GYM_NO = #{gymNo}
        AND INQUIRY_STATUS IN ('예약', '대기')
        ORDER BY VISIT_DATETIME DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 헬스장 번호로 예약된 시간대 조회 -->
    <select id="selectReservedTimesByGymNo" parameterType="_int" resultMap="inquiryReserveResultMap">
        SELECT
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        FROM INQUIRY_RESERVE
        WHERE GYM_NO = #{gymNo}
        AND INQUIRY_STATUS IN ('예약', '대기')
        AND VISIT_DATETIME >= SYSDATE
        ORDER BY VISIT_DATETIME ASC
    </select>

    <!-- 예약 정보 저장 -->
    <insert id="insertReserve" parameterType="InquiryReserve">
        INSERT INTO INQUIRY_RESERVE (
        INQUIRY_NO,
        GYM_NO,
        MEMBER_NO,
        VISIT_DATETIME,
        INQUIRY_STATUS,
        INQUIRY_MEMO
        ) VALUES (
        SEQ_INQUIRY_NO.NEXTVAL,
        #{gymNo},
        #{memberNo},
        #{visitDatetime},
        #{inquiryStatus},
        #{inquiryMemo}
        )
    </insert>

    <!-- 예약 정보 수정 -->
    <update id="updateReserve" parameterType="InquiryReserve">
        UPDATE INQUIRY_RESERVE
        SET VISIT_DATETIME = #{visitDatetime},
        INQUIRY_STATUS = #{inquiryStatus},
        INQUIRY_MEMO = #{inquiryMemo}
        WHERE INQUIRY_NO = #{inquiryNo}
    </update>

    <!-- 예약 삭제 -->
    <delete id="deleteReserve" parameterType="_int">
        DELETE FROM INQUIRY_RESERVE
        WHERE INQUIRY_NO = #{inquiryNo}
    </delete>

</mapper>