<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.gymhub.model.mapper.PtReserveMapper">

    <resultMap id="ptReserveResultMap" type="com.kh.gymhub.model.vo.PtReserve">
        <id property="ptReserveNo" column="PT_RESERVE_NO"/>
        <result property="ptPassNo" column="PT_PASS_NO"/>
        <result property="ptReserveTime" column="PT_RESERVE_TIME"/>
        <result property="ptTrainer" column="PT_TRAINER"/>
        <result property="ptTrainerNo" column="PT_TRAINER_NO"/>
        <result property="ptReserveStatus" column="PT_RESERVE_STATUS"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberPhone" column="MEMBER_PHONE"/>
        <result property="memberPhotoPath" column="MEMBER_PHOTO_PATH"/>
        <result property="trainerName" column="TRAINER_NAME"/>
        <result property="desiredTrainerName" column="DESIRED_TRAINER_NAME"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="gymNo" column="GYM_NO"/>
    </resultMap>

    <!-- 대기중인 PT 예약 조회 (헬스장별) -->
    <select id="selectPendingPtReservesByGymNo" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PP.GYM_NO = #{gymNo}
          AND (PR.PT_RESERVE_STATUS IS NULL OR PR.PT_RESERVE_STATUS = '대기중')
        ORDER BY PR.PT_RESERVE_TIME ASC
    </select>

    <!-- 승인됨/거절됨 PT 예약 조회 (헬스장별, 미래 날짜만) -->
    <select id="selectApprovedOrRejectedPtReservesByGymNo" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PP.GYM_NO = #{gymNo}
          AND PR.PT_RESERVE_STATUS IN ('승인됨', '거절됨')
          AND PR.PT_RESERVE_TIME >= SYSDATE
        ORDER BY PR.PT_RESERVE_TIME ASC
    </select>

    <!-- 대기중인 PT 예약 조회 (페이징) -->
    <select id="selectPendingPtReservesByGymNoPaged" resultMap="ptReserveResultMap">
        SELECT * FROM (
            SELECT ROWNUM RNUM, A.* FROM (
                SELECT 
                    PR.PT_RESERVE_NO,
                    PR.PT_PASS_NO,
                    PR.PT_RESERVE_TIME,
                    PR.PT_TRAINER,
                    PR.PT_TRAINER_NO,
                    NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
                    M.MEMBER_NAME,
                    M.MEMBER_PHONE,
                    T.MEMBER_NAME AS TRAINER_NAME,
                    DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
                    PP.MEMBER_NO,
                    PP.GYM_NO
                FROM PT_RESERVE PR
                INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
                INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
                LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
                LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
                WHERE PP.GYM_NO = #{gymNo}
                  AND (PR.PT_RESERVE_STATUS IS NULL OR PR.PT_RESERVE_STATUS = '대기중')
                ORDER BY PR.PT_RESERVE_TIME ASC
            ) A
        ) WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 대기중인 PT 예약 수 조회 (페이징용) -->
    <select id="selectPendingPtReserveCountByGymNo" parameterType="_int" resultType="_int">
        SELECT COUNT(*)
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        WHERE PP.GYM_NO = #{gymNo}
          AND (PR.PT_RESERVE_STATUS IS NULL OR PR.PT_RESERVE_STATUS = '대기중')
    </select>

    <!-- 승인됨/거절됨 PT 예약 조회 (페이징) -->
    <select id="selectApprovedOrRejectedPtReservesByGymNoPaged" resultMap="ptReserveResultMap">
        SELECT * FROM (
            SELECT ROWNUM RNUM, A.* FROM (
                SELECT 
                    PR.PT_RESERVE_NO,
                    PR.PT_PASS_NO,
                    PR.PT_RESERVE_TIME,
                    PR.PT_TRAINER,
                    PR.PT_TRAINER_NO,
                    NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
                    M.MEMBER_NAME,
                    M.MEMBER_PHONE,
                    T.MEMBER_NAME AS TRAINER_NAME,
                    DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
                    PP.MEMBER_NO,
                    PP.GYM_NO
                FROM PT_RESERVE PR
                INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
                INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
                LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
                LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
                WHERE PP.GYM_NO = #{gymNo}
                  AND PR.PT_RESERVE_STATUS IN ('승인됨', '거절됨')
                  AND PR.PT_RESERVE_TIME >= SYSDATE
                ORDER BY PR.PT_RESERVE_TIME ASC
            ) A
        ) WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 승인됨/거절됨 PT 예약 수 조회 (페이징용) -->
    <select id="selectApprovedOrRejectedPtReserveCountByGymNo" parameterType="_int" resultType="_int">
        SELECT COUNT(*)
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        WHERE PP.GYM_NO = #{gymNo}
          AND PR.PT_RESERVE_STATUS IN ('승인됨', '거절됨')
          AND PR.PT_RESERVE_TIME >= SYSDATE
    </select>

    <!-- PT 예약 승인 -->
    <update id="updatePtReserveApprove">
        UPDATE PT_RESERVE
        SET PT_TRAINER_NO = #{ptTrainerNo},
            PT_RESERVE_STATUS = '승인됨'
        WHERE PT_RESERVE_NO = #{ptReserveNo}
    </update>

    <!-- PT 예약 거절 -->
    <update id="updatePtReserveReject">
        UPDATE PT_RESERVE
        SET PT_RESERVE_STATUS = '거절됨'
        WHERE PT_RESERVE_NO = #{ptReserveNo}
    </update>

    <!-- 회원 탈퇴 시 예정된 PT 예약 취소 처리 -->
    <update id="cancelPtReservesByMemberNo">
        UPDATE PT_RESERVE
        SET PT_RESERVE_STATUS = '거절됨'
        WHERE PT_PASS_NO IN (
            SELECT PT_PASS_NO
            FROM PT_PASS
            WHERE MEMBER_NO = #{memberNo}
        )
        AND PT_RESERVE_TIME >= SYSDATE
        AND PT_RESERVE_STATUS IN ('대기중', '승인됨')
    </update>

    <!-- PT 예약 번호로 조회 -->
    <select id="selectPtReserveByNo" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PR.PT_RESERVE_NO = #{ptReserveNo}
    </select>

    <!-- 날짜별 대기중인 PT 예약 조회 (헬스장별) -->
    <select id="selectPendingPtReservesByGymNoAndDate" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PP.GYM_NO = #{gymNo}
          AND (PR.PT_RESERVE_STATUS IS NULL OR PR.PT_RESERVE_STATUS = '대기중')
          AND TRUNC(PR.PT_RESERVE_TIME) = TO_DATE(#{reserveDate}, 'YYYY-MM-DD')
        ORDER BY PR.PT_RESERVE_TIME ASC
    </select>

    <!-- 날짜별 승인됨/거절됨 PT 예약 조회 (헬스장별) -->
    <select id="selectApprovedOrRejectedPtReservesByGymNoAndDate" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PP.GYM_NO = #{gymNo}
          AND PR.PT_RESERVE_STATUS IN ('승인됨', '거절됨')
          AND TRUNC(PR.PT_RESERVE_TIME) = TO_DATE(#{reserveDate}, 'YYYY-MM-DD')
        ORDER BY PR.PT_RESERVE_TIME ASC
    </select>

    <!-- 트레이너별 승인된 PT 예약 조회 (PT_TRAINER_NO 기반) -->
    <select id="selectApprovedPtReservesByTrainerNo" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            M.MEMBER_PHOTO_PATH,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PR.PT_TRAINER_NO = #{ptTrainerNo}
          AND PR.PT_RESERVE_STATUS = '승인됨'
        ORDER BY PR.PT_RESERVE_TIME ASC
    </select>

    <!-- 날짜별 트레이너별 승인된 PT 예약 조회 (PT_TRAINER_NO 기반) -->
    <select id="selectApprovedPtReservesByTrainerNoAndDate" resultMap="ptReserveResultMap">
        SELECT 
            PR.PT_RESERVE_NO,
            PR.PT_PASS_NO,
            PR.PT_RESERVE_TIME,
            PR.PT_TRAINER,
            PR.PT_TRAINER_NO,
            NVL(PR.PT_RESERVE_STATUS, '대기중') AS PT_RESERVE_STATUS,
            M.MEMBER_NAME,
            M.MEMBER_PHONE,
            M.MEMBER_PHOTO_PATH,
            T.MEMBER_NAME AS TRAINER_NAME,
            DT.MEMBER_NAME AS DESIRED_TRAINER_NAME,
            PP.MEMBER_NO,
            PP.GYM_NO
        FROM PT_RESERVE PR
        INNER JOIN PT_PASS PP ON PR.PT_PASS_NO = PP.PT_PASS_NO
        INNER JOIN MEMBER M ON PP.MEMBER_NO = M.MEMBER_NO
        LEFT JOIN MEMBER T ON PR.PT_TRAINER_NO = T.MEMBER_NO
        LEFT JOIN MEMBER DT ON PR.PT_TRAINER = DT.MEMBER_NO
        WHERE PR.PT_TRAINER_NO = #{ptTrainerNo}
          AND PR.PT_RESERVE_STATUS = '승인됨'
          AND TRUNC(PR.PT_RESERVE_TIME) = TO_DATE(#{reserveDate}, 'YYYY-MM-DD')
        ORDER BY PR.PT_RESERVE_TIME ASC
    </select>

</mapper>

